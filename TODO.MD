ä¸ºäº†ç¡®ä¿å¼€å‘è¿‡ç¨‹é¡ºç•…ï¼Œæˆ‘ä¸ºä½ æ•´ç†äº†ä¸€ä»½è¯¦ç»†çš„ **ã€ŠåŠŸèƒ½å¼€å‘è®¾è®¡æ–‡æ¡£ã€‹** å’Œé…å¥—çš„ **ã€Šæµ‹è¯•ç”¨ä¾‹é›†ã€‹**ã€‚

æˆ‘ä»¬åˆ†ä¸ºä¸¤ä¸ªæ¨¡å—æ¥è®¾è®¡ï¼š
1.  **CoreDNS Server æ ¸å¿ƒä¿®æ”¹**ï¼ˆæ”¯æŒ HTTP DoHï¼‰
2.  **æ–°æ’ä»¶ `rewrite_ip` å¼€å‘**ï¼ˆæ”¯æŒæ™ºèƒ½ IP é‡å†™ï¼‰

---

## ğŸ“‹ å¼€å‘è¿›åº¦è·Ÿè¸ª

| ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ | è¯´æ˜ |
|------|------|----------|------|
| æ¢å¤å®˜æ–¹ rewrite æ’ä»¶ | âœ… å®Œæˆ | 2025-12-17 | ä» upstream æ¢å¤ï¼Œåˆ é™¤æ±¡æŸ“ä»£ç ï¼ˆip.goï¼‰ |
| åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„ | âœ… å®Œæˆ | 2025-12-17 | new_plugin_test/ ç›®å½•åŠå­ç›®å½• |
| ç¼–å†™æµ‹è¯•å·¥å…· | âœ… å®Œæˆ | 2025-12-17 | dns_query.py DNSæŸ¥è¯¢å·¥å…· |
| ç¼–å†™æµ‹è¯•é…ç½®æ–‡ä»¶ | âœ… å®Œæˆ | 2025-12-17 | Corefileé…ç½®ï¼ˆHTTP DoH, æ··åˆåè®®, IPé‡å†™ï¼‰ |
| ç¼–å†™æµ‹è¯•è„šæœ¬ | âœ… å®Œæˆ | 2025-12-17 | test_http_doh.sh, test_rewrite_ip.sh |
| ç¼–å†™ä¸»æµ‹è¯•è¿è¡Œè„šæœ¬ | âœ… å®Œæˆ | 2025-12-17 | run_all_tests.sh |
| æ›´æ–°é…ç½®è¯­æ³• | âœ… å®Œæˆ | 2025-12-17 | ä½¿ç”¨æ–°çš„ doh {} å—è¯­æ³• |
| **å®ç° HTTP DoH æ”¯æŒ** | âœ… å®Œæˆ | 2025-12-17 | **åˆ›å»º plugin/dohï¼Œæ”¯æŒ HTTP å’Œ HTTPS** |
| **å®ç° rewrite_ip æ’ä»¶** | âœ… å®Œæˆ | 2025-12-17 | **æ–°å»º plugin/rewrite_ipï¼Œæ”¯æŒæ™ºèƒ½IPé‡å†™** |
| è¿è¡Œå®Œæ•´æµ‹è¯• | âœ… å®Œæˆ | 2025-12-17 | åŸºç¡€åŠŸèƒ½éªŒè¯é€šè¿‡ |

### ğŸ‰ DoH æ’ä»¶å®ç°å®Œæˆï¼

**å·²å®ŒæˆåŠŸèƒ½**:
- âœ… åˆ›å»º `plugin/doh` æ’ä»¶
- âœ… æ”¯æŒ `doh /dns-query {}` å—çº§é…ç½®
- âœ… HTTP DoH (æ—  TLS) - ç”¨äºæœ¬åœ°/å†…ç½‘ç¯å¢ƒ
- âœ… HTTPS DoH with `tls selfsigned` - è‡ªåŠ¨ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
- âœ… HTTPS DoH with `tls cert.pem key.pem` - ä½¿ç”¨çœŸå®è¯ä¹¦
- âœ… æ··åˆåè®®æ”¯æŒï¼ˆåŒæ—¶ç›‘å¬ HTTP å’Œ HTTPSï¼‰
- âœ… å®Œæ•´æ–‡æ¡£å’Œç¤ºä¾‹

**æµ‹è¯•ç»“æœ**:
```bash
# HTTP DoH (ç«¯å£ 8053)
âœ“ æˆåŠŸè¿”å› DNS å“åº”: example.com -> 104.20.34.220, 172.66.144.113

# HTTPS DoH (ç«¯å£ 8443, è‡ªç­¾åè¯ä¹¦)
âœ“ TLS è¿æ¥æˆåŠŸ
âœ“ æˆåŠŸè¿”å› DNS å“åº”: example.com -> 104.20.34.220, 172.66.144.113

# æ··åˆåè®®
âœ“ HTTP (8053) å’Œ HTTPS (8443) åŒæ—¶å·¥ä½œ
```

**é…ç½®ç¤ºä¾‹**:
```corefile
# HTTP DoH
.:8053 {
    doh /dns-query
    forward . 8.8.8.8
}

# HTTPS DoH
.:8443 {
    doh /dns-query {
        tls selfsigned
    }
    forward . 8.8.8.8
}
```

### ğŸ‰ rewrite_ip æ’ä»¶å®ç°å®Œæˆï¼

**å·²å®ŒæˆåŠŸèƒ½**:
- âœ… åˆ›å»º `plugin/rewrite_ip` æ’ä»¶
- âœ… æ”¯æŒé€šé…ç¬¦æ¨¡å¼åŒ¹é… (`*.example.com`)
- âœ… æ”¯æŒåŸŸåæ˜ å°„ (`map_to gateway.local`)
- âœ… ç±»å‹ä¸¥æ ¼åŒ¹é…ï¼ˆA è®°å½• â†’ IPv4ï¼ŒAAAA è®°å½• â†’ IPv6ï¼‰
- âœ… Fallback æœºåˆ¶ï¼ˆhosts æ–‡ä»¶ä¸­æ— è®°å½•æ—¶ä¿ç•™åŸå§‹ IPï¼‰
- âœ… ResponseWriter wrapper æ‹¦æˆªå“åº”å¹¶ä¿®æ”¹
- âœ… å®Œæ•´æ–‡æ¡£å’Œé…ç½®ç¤ºä¾‹

**æµ‹è¯•ç»“æœ**:
```bash
# æµ‹è¯• 1: example.com (é‡å†™)
åŸå§‹ IP: 104.20.34.220, 172.66.144.113
é‡å†™å: 10.0.0.1, 10.0.0.1 âœ“

# æµ‹è¯• 2: github.com (ä¸é‡å†™)
ä¿ç•™åŸå§‹ IP: 20.205.243.166 âœ“
```

**é…ç½®ç¤ºä¾‹**:
```corefile
.:8053 {
    rewrite_ip {
        match *.example.com
        hosts /path/to/hosts_file.txt
    }
    forward . 8.8.8.8
}
```

**å…³é”®æŠ€æœ¯ç‚¹**:
- æ’ä»¶å¿…é¡»æ”¾åœ¨ `forward` ä¹‹å‰æ‰èƒ½æ‹¦æˆªå“åº”
- ä½¿ç”¨ `dns.ResponseWriter` wrapper æ¨¡å¼
- æ”¯æŒ IPv4/IPv6 åˆ†ç¦»å­˜å‚¨å’ŒæŸ¥è¯¢

### ğŸ“¦ å·²å®Œæˆçš„æµ‹è¯•å¥—ä»¶

æµ‹è¯•å¥—ä»¶ä½äº `new_plugin_test/` ç›®å½•ï¼ŒåŒ…å«ï¼š
- **æµ‹è¯•è„šæœ¬**: 9ä¸ªå®Œæ•´æµ‹è¯•ç”¨ä¾‹ï¼ˆTC-01 åˆ° TC-09ï¼‰
- **é…ç½®æ–‡ä»¶**: å¤šä¸ª Corefile é…ç½®ç¤ºä¾‹
  - [Corefile.http_doh](new_plugin_test/configs/Corefile.http_doh) - HTTP DoH æµ‹è¯•
  - [Corefile.https_doh](new_plugin_test/configs/Corefile.https_doh) - HTTPS DoH æµ‹è¯•  
  - [Corefile.rewrite_ip](new_plugin_test/configs/Corefile.rewrite_ip) - IP é‡å†™æµ‹è¯•
  - **[Corefile.all](new_plugin_test/configs/Corefile.all) - å¤§ä¸€ç»Ÿé…ç½®** âœ¨
- **å·¥å…·å‡½æ•°**: Python DNS æŸ¥è¯¢å·¥å…·
- **æ–‡æ¡£**: å®Œæ•´çš„ README å’Œä½¿ç”¨è¯´æ˜

**å¤§ä¸€ç»Ÿé…ç½®æµ‹è¯•ç»“æœ**:
```bash
âœ… æ ‡å‡† DNS (8053):  example.com -> 10.0.0.1
âœ… HTTP DoH (8080):  example.com -> 10.0.0.1  
âœ… HTTPS DoH (8443): æ­£å¸¸å·¥ä½œï¼ˆéœ€è·³è¿‡SSLéªŒè¯ï¼‰
```

**å¿«é€Ÿè¿è¡Œæµ‹è¯•**:
```bash
# å¤§ä¸€ç»Ÿæµ‹è¯•
cd /workspaces/coredns
./coredns -conf new_plugin_test/configs/Corefile.all

# æµ‹è¯•æ‰€æœ‰ç«¯å£
dig @127.0.0.1 -p 8053 example.com  # æ ‡å‡† DNS
python3 new_plugin_test/utils/dns_query.py example.com \
    --doh http://127.0.0.1:8080/dns-query  # HTTP DoH
```

è¯¦è§: [new_plugin_test/README.md](new_plugin_test/README.md)

---

# ğŸ“˜ CoreDNS åŠŸèƒ½æ‰©å±•å¼€å‘æ–‡æ¡£

## æ¨¡å—ä¸€ï¼šHTTP DoH æ”¯æŒ (No-TLS)

### 1. è®¾è®¡ç›®æ ‡
ä¿®æ”¹ CoreDNS çš„å¯åŠ¨é€»è¾‘å’Œ DoH æœåŠ¡ç«¯å®ç°ï¼Œä½¿å…¶æ”¯æŒéåŠ å¯†çš„ HTTP åè®®ï¼Œä»¥ä¾¿åœ¨æœ¬åœ°å—ä¿¡ä»»ç¯å¢ƒï¼ˆå¦‚ Service Mesh sidecar æˆ–æœ¬åœ°ä»£ç†ï¼‰ä¸­ä½¿ç”¨ã€‚

### 2. ä»£ç ä¿®æ”¹ç‚¹

#### A. åè®®è¯†åˆ« (`core/dnsserver`)
ç›®å‰ CoreDNS é€šå¸¸æ ¹æ®å‰ç¼€ï¼ˆå¦‚ `tls://`, `https://`ï¼‰æˆ–ç«¯å£æ¥åˆ¤æ–­ Server ç±»å‹ã€‚
*   **ä¿®æ”¹ç›®æ ‡**ï¼šåœ¨è§£æ Corefile Server Block æ—¶ï¼Œæ”¯æŒè¯†åˆ« `http://` å‰ç¼€ã€‚
*   **é€»è¾‘**ï¼š
    *   å¦‚æœç›‘æµ‹åˆ° `http://` å‰ç¼€ï¼Œæ ‡è®°è¯¥ Server ä¸º DoH ç±»å‹ï¼Œä½† `TLSConfig` ä¸º nilã€‚
    *   ç«¯å£ç›‘å¬é€»è¾‘æ”¹ä¸ºæ ‡å‡†çš„ `net.Listen` è€Œé `tls.Listen`ã€‚

#### B. DoH Server å®ç° (`plugin/doh` æˆ– `server/doh`)
*   **ç°æœ‰çš„é€»è¾‘**ï¼šå¼ºä¾èµ– `http.ListenAndServeTLS`ã€‚
*   **ä¿®æ”¹å»ºè®®**ï¼š
    *   åœ¨ Server ç»“æ„ä½“ä¸­å¢åŠ  `PlainHTTP bool` å­—æ®µã€‚
    *   å¯åŠ¨æ—¶åˆ¤æ–­ï¼š
        *   è‹¥ `PlainHTTP` ä¸º `true`ï¼Œä½¿ç”¨ `http.Server{}` å¹¶è°ƒç”¨ `ListenAndServe()`ã€‚
        *   åŒæ—¶éœ€æ³¨æ„ HTTP/2 çš„æ”¯æŒï¼ˆH2Cï¼‰ï¼Œæˆ–è€…ä»…æ”¯æŒ HTTP/1.1ï¼ˆè§† Go çš„ `net/http` é»˜è®¤è¡Œä¸ºè€Œå®šï¼Œé€šå¸¸å»ºè®®åœ¨ Cleartext ä¸‹ä¹Ÿå°½é‡æ”¯æŒ H2ï¼‰ã€‚

### 3. é…ç½®ç¤ºä¾‹

**âœ… æ›´æ–°: å·²é‡‡ç”¨æ–°çš„é…ç½®è¯­æ³•** (2025-12-17)

```corefile
# HTTP DoH (ä¸ä½¿ç”¨ TLS)
.:8053 {
    doh /dns-query {
        # ä¸å†™tlså°±æ˜¯http
    }
}

# HTTPS DoH (ä½¿ç”¨è‡ªç­¾åè¯ä¹¦)
.:8443 {
    doh /dns-query {
        tls selfsigned
    }
}

# HTTPS DoH (ä½¿ç”¨çœŸå®è¯ä¹¦)
.:8443 {
    doh /dns-query {
        tls cert.pem key.pem
    }
}
```

**è¯´æ˜**:
- `doh` æŒ‡ä»¤é‡‡ç”¨å—è¯­æ³•ï¼Œè€Œéé¡¶å±‚åè®®å‰ç¼€
- ä¸æŒ‡å®š `tls` æ—¶é»˜è®¤ä½¿ç”¨ HTTPï¼ˆæ— åŠ å¯†ï¼‰
- `tls selfsigned` è‡ªåŠ¨ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ç”¨äºæµ‹è¯•
- `tls <cert> <key>` ä½¿ç”¨æŒ‡å®šçš„è¯ä¹¦æ–‡ä»¶

---

## æ¨¡å—äºŒï¼šRewrite IP æ’ä»¶å¼€å‘

### 1. æ’ä»¶ç»“æ„
æ–°å»ºæ’ä»¶ç›®å½• `plugin/rewrite_ip`ã€‚

**æ ¸å¿ƒç»“æ„ä½“ `RewriteIP`**:
```go
type RewriteIP struct {
    Next  plugin.Handler
    Rules []Rule
}

type Rule struct {
    Patterns []string    // é€šé…ç¬¦æ¨¡å¼ï¼Œå¦‚ *.example.com
    MapTo    string      // æ˜ å°„ç›®æ ‡åŸŸåï¼ˆå¯é€‰ï¼‰ï¼Œå¦‚ backend.local
    HostFile *HostFile   // è§£æåçš„ hosts æ–‡ä»¶æ•°æ®
}
```

### 2. æ ¸å¿ƒé€»è¾‘ (`ServeDNS`)

ç”±äºæˆ‘ä»¬éœ€è¦ä¿®æ”¹ **å“åº”å†…å®¹**ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥åœ¨è¯·æ±‚é˜¶æ®µå¤„ç†ã€‚å¿…é¡»ä½¿ç”¨ `ResponseWriter` åŒ…è£…å™¨ï¼ˆWrapperï¼‰ã€‚

**æµç¨‹å›¾ï¼š**
1.  **Intercept**: ä½¿ç”¨ `ResponsePrinter` åŒ…è£… `dns.ResponseWriter`ã€‚
2.  **Forward**: è°ƒç”¨ `plugin.Next.ServeDNS` è®©åç«¯æ’ä»¶ï¼ˆå¦‚ `forward`ï¼‰å»è·å–çœŸå® IPã€‚
3.  **Process Response** (åœ¨ WriteMsg é˜¶æ®µ):
    *   éå†å“åº”æ¶ˆæ¯ä¸­çš„ `Msg.Answer` åˆ—è¡¨ã€‚
    *   å¯¹äºæ¯ä¸€æ¡ `A` æˆ– `AAAA` è®°å½•ï¼š
        *   **Step 1**: éå† `Rules` åˆ—è¡¨ã€‚
        *   **Step 2**: æ£€æŸ¥è®°å½•çš„ `Header().Name` æ˜¯å¦åŒ¹é… `Rule.Patterns`ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰ã€‚
        *   **Step 3**: åŒ¹é…æˆåŠŸåï¼š
            *   **Direct Mode**: å¦‚æœ `MapTo` ä¸ºç©ºï¼Œç”¨åŸå§‹åŸŸåå»æŸ¥ `HostFile`ã€‚
            *   **Mapped Mode**: å¦‚æœ `MapTo` ä¸ä¸ºç©ºï¼Œç”¨ `MapTo` çš„åŸŸåå»æŸ¥ `HostFile`ã€‚
        *   **Step 4 (Strict Match)**:
            *   å¦‚æœæ˜¯ `A` è®°å½•ï¼Œåªä» HostFile æ‹¿ IPv4ã€‚
            *   å¦‚æœæ˜¯ `AAAA` è®°å½•ï¼Œåªä» HostFile æ‹¿ IPv6ã€‚
        *   **Step 5**: å¦‚æœæŸ¥åˆ°äº† IPï¼Œä¿®æ”¹ `RR.A` æˆ– `RR.AAAA` å­—æ®µï¼›æ²¡æŸ¥åˆ°åˆ™è·³è¿‡ã€‚
    *   å‘é€ä¿®æ”¹åçš„æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ã€‚

### 3. Hosts æ–‡ä»¶è§£æå™¨
*   éœ€è¦å®ç°ä¸€ä¸ªè½»é‡çº§çš„è§£æå™¨ï¼Œæˆ–è€…å¤ç”¨ CoreDNS ç°æœ‰çš„ `plugin/hosts` ä¸­çš„é€»è¾‘ã€‚
*   **æ•°æ®ç»“æ„**ï¼š
    ```go
    map[string]struct{
        IPv4 []net.IP
        IPv6 []net.IP
    }
    ```
*   æ”¯æŒçƒ­åŠ è½½ï¼ˆå¯é€‰ï¼Œåˆ©ç”¨ `fsnotify` ç›‘æ§æ–‡ä»¶å˜åŒ–ï¼‰ã€‚

---

# ğŸ§ª æµ‹è¯•ç”¨ä¾‹é›† (Test Cases)

ä¸ºäº†ä¿è¯åŠŸèƒ½ç¨³å¥ï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›–ä»¥ä¸‹åœºæ™¯ã€‚

## Part 1: HTTP DoH è¿é€šæ€§æµ‹è¯•

| ID | æµ‹è¯•åç§° | å‰ç½®æ¡ä»¶ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ |
| :--- | :--- | :--- | :--- | :--- |
| **TC-01** | **HTTP DoH åŸºç¡€æŸ¥è¯¢** | å¯åŠ¨ CoreDNS ç›‘å¬ `:8053` (HTTP) | ä½¿ç”¨ `curl` å‘é€ DoH è¯·æ±‚ï¼š<br>`curl -v -H "Content-Type: application/dns-message" --data-binary @query.bin http://127.0.0.1:8053/dns-query` | 1. å“åº”çŠ¶æ€ç  200 OK<br>2. Body è¿”å›æœ‰æ•ˆçš„ DNS å“åº”äºŒè¿›åˆ¶æµ<br>3. æ—  TLS æ¡æ‰‹è¿‡ç¨‹ |
| **TC-02** | **æ··åˆåè®®å…±å­˜** | ç›‘å¬ `:8053` (HTTP) å’Œ `:8443` (HTTPS) | åˆ†åˆ«å‘ä¸¤ä¸ªç«¯å£å‘é€è¯·æ±‚ | ä¸¤ä¸ªç«¯å£å‡èƒ½æ­£å¸¸è§£æ DNSï¼Œäº’ä¸å¹²æ‰° |

## Part 2: IP Rewrite åŠŸèƒ½æµ‹è¯•

**ç¯å¢ƒå‡†å¤‡ï¼š**
*   **HostFile A (`hosts_direct.txt`)**:
    ```
    10.0.0.1  api.test.com
    ::1       api.test.com
    ```
*   **HostFile B (`hosts_mapped.txt`)**:
    ```
    192.168.1.100  gateway.local
    2001:db8::1    gateway.local
    ```

**é…ç½®ç‰‡æ®µï¼š**
```corefile
.:8053 {
    # è§„åˆ™1: ç›´æ¥é‡å†™
    rewrite_ip {
        match *.test.com
        hosts /path/to/hosts_direct.txt
    }
    
    # è§„åˆ™2: æ˜ å°„é‡å†™
    rewrite_ip {
        match *.prod.com
        map_to gateway.local
        hosts /path/to/hosts_mapped.txt
    }
    
    forward . 8.8.8.8
}
```

**âœ… æµ‹è¯•é…ç½®å·²å°±ç»ª**: å‚è§ `new_plugin_test/configs/Corefile.rewrite_ip`

| ID | æµ‹è¯•åç§° | è¾“å…¥ (DNS å“åº”åŸå€¼) | åŒ¹é…é€»è¾‘ | é¢„æœŸè¾“å‡º (å®¢æˆ·ç«¯æ”¶åˆ°çš„å€¼) | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **TC-03** | **ç›´æ¥é‡å†™ IPv4** | `api.test.com` -> `1.1.1.1` (A) | åŒ¹é…è§„åˆ™1 (`*.test.com`)<br>æŸ¥ `hosts_direct` æ‰¾ `api.test.com` | `api.test.com` -> `10.0.0.1` | æˆåŠŸæ›¿æ¢ |
| **TC-04** | **ç›´æ¥é‡å†™ IPv6** | `api.test.com` -> `2606::1` (AAAA) | åŒ¹é…è§„åˆ™1<br>æŸ¥ IPv6 | `api.test.com` -> `::1` | æˆåŠŸæ›¿æ¢ |
| **TC-05** | **æ˜ å°„é‡å†™ IPv4** | `service.prod.com` -> `8.8.8.8` (A) | åŒ¹é…è§„åˆ™2 (`*.prod.com`)<br>æ˜ å°„ä¸º `gateway.local`<br>æŸ¥ `hosts_mapped` | `service.prod.com` -> `192.168.1.100` | å®ç°äº†å¤šå­åŸŸèšåˆåˆ°ä¸€ä¸ªIP |
| **TC-06** | **ç±»å‹ä¸¥æ ¼åŒ¹é… (Missing V6)** | `service.prod.com` -> `2001::1` (AAAA) | å‡è®¾ `hosts_mapped` é‡Œåˆ æ‰äº† IPv6 è®°å½• | `service.prod.com` -> `2001::1` | **ä¿æŒåŸå€¼** (ä¸å›é€€åˆ°IPv4ï¼Œä¹Ÿä¸è¿”å›ç©º) |
| **TC-07** | **æ— åŒ¹é…è§„åˆ™** | `www.google.com` -> `142.250.x.x` | æ— è§„åˆ™åŒ¹é… | `www.google.com` -> `142.250.x.x` | åŸå°ä¸åŠ¨ |
| **TC-08** | **Hostæ–‡ä»¶ä¸­æ— è®°å½•** | `unknown.test.com` -> `1.2.3.4` | åŒ¹é…è§„åˆ™1<br>ä½† `hosts_direct` ä¸­æ— æ­¤åŸŸå | `unknown.test.com` -> `1.2.3.4` | **ä¿æŒåŸå€¼** (Fallback) |
| **TC-09** | **å¤šæ¡è®°å½•æ··åˆ** | `api.test.com` (A) + `other.com` (A) | åªæœ‰ `api` åŒ¹é… | `api` å˜æ›´ä¸º `10.0.0.1`<br>`other` ä¿æŒåŸå€¼ | ä»…é‡å†™åŒ¹é…çš„è®°å½• |
